<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>acutils.handler &mdash; acutils 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            acutils
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">acutils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">acutils</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">acutils.handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for acutils.handler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">file</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">multiprocess</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">sheet</span>



<div class="viewcode-block" id="DataHandler">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler">[docs]</a>
<span class="k">class</span> <span class="nc">DataHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main class to handle data on disk.</span>

<span class="sd">    ATTRIBUTES</span>
<span class="sd">    ----------</span>
<span class="sd">    (str) datapath:</span>
<span class="sd">        Absolute path to the directory that contain source files.</span>
<span class="sd">    </span>
<span class="sd">    (array/list like of str) file_extensions=None:</span>
<span class="sd">        Source file allowed extensions.</span>
<span class="sd">    </span>
<span class="sd">    (int) allowed_cpus=1:</span>
<span class="sd">        Maximum amount of CPUs used to compute.</span>
<span class="sd">    </span>
<span class="sd">    (int) seed=871:</span>
<span class="sd">        Seed used to initialize numpy randomizer.</span>
<span class="sd">    </span>
<span class="sd">    (str) str_ndarray_dtype=&quot;U256&quot;:</span>
<span class="sd">        Data type used for any string numpy arrays. It defines the maximum </span>
<span class="sd">            length of strings, especially those in sheet files, for loading </span>
<span class="sd">            labels and groups.</span>
<span class="sd">    </span>
<span class="sd">    (numpy.array&lt;str_ndarray_dtype&gt;) files=None:</span>
<span class="sd">        The filenames (with extension) of the files to load.</span>
<span class="sd">    </span>
<span class="sd">    (numpy.array&lt;str_ndarray_dtype&gt;) labels=None:</span>
<span class="sd">        The labels of the files.</span>
<span class="sd">    </span>
<span class="sd">    (numpy.array&lt;str_ndarray_dtype&gt;) unique_labels=None:</span>
<span class="sd">        The unique labels among the labels.</span>
<span class="sd">    </span>
<span class="sd">    (numpy.array&lt;str_ndarray_dtype&gt;) groups=None:</span>
<span class="sd">        The groups of the files, all with the same will be in the same dataset split.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">file_extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">871</span><span class="p">,</span>
                 <span class="n">str_ndarray_dtype</span><span class="o">=</span><span class="s2">&quot;U256&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initiate DataHandler instance to handle data on disk.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) datapath:</span>
<span class="sd">		    Absolute path to the directory that contain source files.</span>
<span class="sd">        </span>
<span class="sd">		(array/list like of str) file_extensions=None:</span>
<span class="sd">		    Source file allowed extensions.</span>
<span class="sd">        </span>
<span class="sd">		(int) allowed_cpus=1:</span>
<span class="sd">		    Maximum amount of CPUs used to compute.</span>
<span class="sd">        </span>
<span class="sd">		(int) seed=871:</span>
<span class="sd">		    Seed used to initialize numpy randomizer.</span>
<span class="sd">        </span>
<span class="sd">		(str) str_ndarray_dtype=&quot;U256&quot;:</span>
<span class="sd">		    Data type used for any string numpy arrays. It defines the maximum </span>
<span class="sd">                length of strings, especially those in sheet files, for loading </span>
<span class="sd">                labels and groups.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        </span>
<span class="sd">        RAISES</span>
<span class="sd">        ------</span>
<span class="sd">        (NotADirectoryError) err: </span>
<span class="sd">            if the absolute path doesn&#39;t lead to an existing directory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datapath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s2">&quot;datapath must be an absolute path to an &quot;</span>
                                     <span class="s2">&quot;existing directory&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">=</span> <span class="n">datapath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span> <span class="o">=</span> <span class="n">file_extensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_cpus</span> <span class="o">=</span> <span class="n">allowed_cpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span> <span class="o">=</span> <span class="n">str_ndarray_dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_format_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">filecol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labelcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">othercols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                      <span class="n">clueless_words</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Format a dataframe by deleting rows with empty cell, also add extension </span>
<span class="sd">        to filenames if filename doesn&#39;t contain it already, and if there is </span>
<span class="sd">        only one extension.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(pandas.DataFrame) df:</span>
<span class="sd">		    dataframe to format</span>
<span class="sd">        </span>
<span class="sd">		(str) filecol=None:</span>
<span class="sd">		    Name of the column that contains filenames, not used there.</span>
<span class="sd">        </span>
<span class="sd">		(str) labelcol=None:</span>
<span class="sd">		    Name of the column that contains labels, not used there.</span>
<span class="sd">        </span>
<span class="sd">		(list&lt;str&gt;) othercols=None:</span>
<span class="sd">		    Name of the other columns, not used there.</span>
<span class="sd">        </span>
<span class="sd">		(array/list like of str) clueless_words=None:</span>
<span class="sd">		    Strings considered as None.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(pandas.DataFrame) df:</span>
<span class="sd">		    formated dataframe.</span>
<span class="sd">    </span>
<span class="sd">        RAISES</span>
<span class="sd">        ------</span>
<span class="sd">        None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">sheet</span><span class="o">.</span><span class="n">delete_clueless_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clueless_words</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_load_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheetpath</span><span class="p">,</span> <span class="n">filecol</span><span class="p">,</span> <span class="n">labelcol</span><span class="p">,</span> <span class="n">othercols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a sheet file and keep indicated columns.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) sheetpath:</span>
<span class="sd">		    Absolute path to the sheet which contain information about data.</span>
<span class="sd">        </span>
<span class="sd">		(str) filecol=None:</span>
<span class="sd">		    Name of the column that contains filenames.</span>
<span class="sd">        </span>
<span class="sd">		(str) labelcol=None:</span>
<span class="sd">		    Name of the column that contains labels, not used here.</span>
<span class="sd">        </span>
<span class="sd">		(iterable of str) othercols=None:</span>
<span class="sd">		    Name of the other columns to keep.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(pandas.DataFrame) df:</span>
<span class="sd">		    Loaded dataframe.</span>

<span class="sd">        RAISES</span>
<span class="sd">        ------</span>
<span class="sd">        (ValueError) err:</span>
<span class="sd">            If the file extension is not supported.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">othercols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">othercols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">othercols</span><span class="p">]</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filecol</span><span class="p">)</span> <span class="p">;</span> <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelcol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sheet</span><span class="o">.</span><span class="n">read_df_from_any_avalaible_extensions</span><span class="p">(</span><span class="n">sheetpath</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span>


<div class="viewcode-block" id="DataHandler.load_data_fromdatapath">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.load_data_fromdatapath">[docs]</a>
    <span class="k">def</span> <span class="nf">load_data_fromdatapath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load data files from data directory.</span>
<span class="sd">        Assuming that those files are directly inside the data directory.</span>
<span class="sd">        The filenames are stored as &quot;files&quot; attribute.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------</span>
<span class="sd">		None</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">anyfile</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="c1"># if no extension, keep any</span>
                   <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">)</span> 
                              <span class="k">if</span> <span class="n">anyfile</span> 
                              <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span><span class="p">))],</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataHandler.load_labels_fromsheet">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.load_labels_fromsheet">[docs]</a>
    <span class="k">def</span> <span class="nf">load_labels_fromsheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheetpath</span><span class="p">,</span> <span class="n">idcol</span><span class="p">,</span> <span class="n">labelcol</span><span class="p">,</span> 
            <span class="n">othercols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clueless_words</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delete_unlabeled_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">require_full_filename_match</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load data labels from a sheet file. </span>
<span class="sd">        You must load files before calling this, you might call </span>
<span class="sd">        &quot;load_data_fromdatapath&quot;. The labels are stored as &quot;labels&quot; attribute </span>
<span class="sd">        and their unique values are stored as &quot;unique_labels&quot; attribute.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) sheetpath:</span>
<span class="sd">		    Absolute path to the sheet which contain information about data.</span>
<span class="sd">        </span>
<span class="sd">		(str) idcol=None:</span>
<span class="sd">		    Name of the column that contains at least a part of the filename.</span>
<span class="sd">        </span>
<span class="sd">		(str) labelcol=None:</span>
<span class="sd">		    Name of the column that contains labels, not used here.</span>
<span class="sd">        </span>
<span class="sd">		(array/list like of str) othercols=None:</span>
<span class="sd">		    Name of the other columns to keep.</span>
<span class="sd">        </span>
<span class="sd">		(array/list like of str) clueless_words=None:</span>
<span class="sd">		    Strings considered as None.</span>
<span class="sd">        </span>
<span class="sd">		(bool) delete_unlabeled_files=True:</span>
<span class="sd">		    If True, delete each file without label.</span>
<span class="sd">        </span>
<span class="sd">		(bool) require_full_filename_match=False:</span>
<span class="sd">		    If True, requires the value in the idcol to be exactly the filename,</span>
<span class="sd">            otherwise, if the value in the idcol is included in the filename, </span>
<span class="sd">            it is considered as a match. Note that if the idcol value is </span>
<span class="sd">            included in multiple filenames, it will be associated with the </span>
<span class="sd">            first one found, in descending length order.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Load and format sheet</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_sheet</span><span class="p">(</span><span class="n">sheetpath</span><span class="p">,</span> <span class="n">idcol</span><span class="p">,</span> <span class="n">labelcol</span><span class="p">,</span> <span class="n">othercols</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">labelcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">labelcol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_sheet</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">idcol</span><span class="p">,</span> <span class="n">labelcol</span><span class="p">,</span> <span class="n">othercols</span><span class="p">,</span> <span class="n">clueless_words</span><span class="p">)</span>

        <span class="c1"># Browse files through the size of those names (descending order)</span>
        <span class="c1"># So if a smaller is included inside a bigger, its exit before disturbing</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">idstr</span><span class="p">)</span> <span class="k">for</span> <span class="n">idstr</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get the label of each corresponding file</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">filepart</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">labelcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">filepart</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">require_full_filename_match</span> <span class="ow">and</span> <span class="n">filepart</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                    <span class="k">break</span>
        
        <span class="c1"># Update labels</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| no label keeped, nothing changed. Leaving.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">delete_unlabeled_files</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
                                           <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataHandler.load_labeled_data_fromdatapath">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.load_labeled_data_fromdatapath">[docs]</a>
    <span class="k">def</span> <span class="nf">load_labeled_data_fromdatapath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load data files and labels from data directory.</span>
<span class="sd">        Assuming that those files are inside subdirectories (named with unique </span>
<span class="sd">        labels). The filenames are stored as &quot;files&quot; attribute. The labels are </span>
<span class="sd">        stored as &quot;labels&quot; attribute and their unique values are stored as </span>
<span class="sd">        &quot;unique_labels&quot; attribute.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------</span>
<span class="sd">		None</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Init arrays</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">)</span> 
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">label</span><span class="p">))],</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>

        <span class="c1"># Fill them label per label with founded files (if the ext is allowed)</span>
        <span class="n">anyfile</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="c1"># if no extension, keep any</span>
                   <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">):</span>
            <span class="n">incoming_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span> 
                    <span class="k">if</span> <span class="n">anyfile</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span><span class="p">)</span>
                <span class="p">)]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">incoming_files</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">unique_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># a label without data is useless</span>
                <span class="k">continue</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">files</span><span class="p">,</span> <span class="n">incoming_files</span><span class="p">])</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels</span><span class="p">,</span> 
                            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">label</span><span class="p">]),</span> <span class="n">incoming_files</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        
        <span class="c1"># Update attributes only if not empty</span>
        <span class="k">if</span> <span class="n">files</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">unique_labels</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| no file or label keeped, nothing changed. Leaving.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span> <span class="o">=</span> <span class="n">unique_labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span></div>

    

<div class="viewcode-block" id="DataHandler.load_groups_fromsheet">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.load_groups_fromsheet">[docs]</a>
    <span class="k">def</span> <span class="nf">load_groups_fromsheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheetpath</span><span class="p">,</span> <span class="n">idcol</span><span class="p">,</span> <span class="n">groupcol</span><span class="p">,</span> 
            <span class="n">clueless_words</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_full_filename_match</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load data groups from a sheet file. </span>
<span class="sd">        You must load files before calling this, you might call </span>
<span class="sd">        &quot;load_data_fromdatapath&quot;. The groups are stored as &quot;groups&quot; attribute.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) sheetpath:</span>
<span class="sd">		    Absolute path to the sheet which contain information about data.</span>
<span class="sd">        </span>
<span class="sd">		(str) idcol=None:</span>
<span class="sd">		    Name of the column that contains at least a part of the filename.</span>
<span class="sd">        </span>
<span class="sd">		(str) groupcol=None:</span>
<span class="sd">		    Name of the column that contains groups, not used here.</span>
<span class="sd">        </span>
<span class="sd">		(array/list like of str) clueless_words=None:</span>
<span class="sd">		    Strings considered as None.</span>
<span class="sd">        </span>
<span class="sd">		(bool) require_full_filename_match=False:</span>
<span class="sd">		    If True, requires the value in the idcol to be exactly the filename,</span>
<span class="sd">            otherwise, if the value in the idcol is included in the filename, </span>
<span class="sd">            it is considered as a match. Note that if the idcol value is </span>
<span class="sd">            included in multiple filenames, it will be associated with the </span>
<span class="sd">            first one found, in descending length order.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Load and format sheet</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">read_df_from_any_avalaible_extensions</span><span class="p">(</span><span class="n">sheetpath</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">groupcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">groupcol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Be sure that &#39;&#39; is considered as empty</span>
        <span class="k">if</span> <span class="n">clueless_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clueless_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clueless_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">clueless_words</span><span class="p">]</span>

        <span class="c1"># Browse files through the size of those names (descending order)</span>
        <span class="c1"># So if a smaller is included inside a bigger, its exit before disturbing</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">idstr</span><span class="p">)</span> <span class="k">for</span> <span class="n">idstr</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get the group of each corresponding file (if avalaible)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span> <span class="c1"># in case no group, filename becomes the group</span>
            <span class="k">for</span> <span class="n">filepart</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">groupcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">filepart</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">require_full_filename_match</span> <span class="ow">and</span> <span class="n">filepart</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span> 
                                 <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clueless_words</span> 
                                 <span class="k">else</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span></div>



    <span class="k">def</span> <span class="nf">_balance_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Balance dataset so the amount of data is equal for each label.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(dict&lt;str;str&gt;) data:</span>
<span class="sd">		    Dictionary with filename as key and label as value.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(dict&lt;str;str&gt;) balanced_data:</span>
<span class="sd">		    Data without superfluous files to balance it.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">balanced_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Check how much data should be keeped (amout of labels with less data)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">balanced_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">balanced_data</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
             <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span><span class="p">])</span>
        <span class="n">keeped_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lengths</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lengths</span><span class="p">)])</span> <span class="c1"># if no data, error</span>
        
        <span class="c1"># Balance data for each label</span>
        <span class="k">for</span> <span class="n">length</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">keeped_data</span> <span class="c1"># find how much data should be deleted</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="c1"># so the balance is repeatable</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="c1"># but still random</span>
                <span class="c1"># delete &quot;diff&quot; files from this label</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="n">ids</span><span class="p">][:</span><span class="n">diff</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="n">balanced_data</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">balanced_data</span>


<div class="viewcode-block" id="DataHandler.balance_datasets">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.balance_datasets">[docs]</a>
    <span class="k">def</span> <span class="nf">balance_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Balance datasets so the amount of data is equal for each label.</span>
<span class="sd">        This is basically calling &quot;_balance_dataset&quot; method with tdata then vdata.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(dict&lt;str;str&gt;) tdata:</span>
<span class="sd">		    Train dictionary with filename as key and label as value.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) vdata:</span>
<span class="sd">		    Val dictionary with filename as key and label as value.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(dict&lt;str;str&gt;) balanced_tdata:</span>
<span class="sd">		    Train data without superfluous files to balance it.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) balanced_vdata:</span>
<span class="sd">		    Val data without superfluous files to balance it.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance_dataset</span><span class="p">(</span><span class="n">tdata</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance_dataset</span><span class="p">(</span><span class="n">vdata</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">_split_using_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_percentage</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Split labeled data into train and test datasets considering data groups.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(float) train_percentage=0.7:</span>
<span class="sd">		    Percentage of data expected in train dataset.</span>
<span class="sd">        </span>
<span class="sd">		(bool) balance=False:</span>
<span class="sd">		    Do call &quot;balance_datasets&quot; method before returning dictionaries.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(dict&lt;str;str&gt;) tdata:</span>
<span class="sd">		    Train dictionary with filename as key and label as value.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) vdata:</span>
<span class="sd">		    Val dictionary with filename as key and label as value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> 
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| Load labeled data before calling &quot;split&quot;. &#39;</span>
                  <span class="s1">&#39;&quot;files&quot;, &quot;labels&quot; and &quot;unique_labels&quot; attributes should not &#39;</span>
                  <span class="s1">&#39;be None. Leaving.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| Load groups before calling &quot;split&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">train_percentage</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">train_percentage</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| should be: 0.00 &lt;= &quot;train_percentage&quot; &lt;= 1.00. Leaving.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Init lists to store train/val files and labels</span>
        <span class="n">train_files</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">val_files</span><span class="p">,</span> <span class="n">val_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="c1"># Fill train/val files/labels lab per lab referring to train_percentage</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span><span class="p">:</span>
            <span class="c1"># Get groups for data with this label</span>
            <span class="n">iftl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># indices for this label</span>
            <span class="n">unique_groups</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">iftl</span><span class="p">],</span> 
                                                 <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                 <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Shuffle to split it randomly</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="c1"># so the split is repeatable</span>
            <span class="n">browsing_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">unique_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                              <span class="n">size</span><span class="o">=</span><span class="n">unique_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                              <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>

            <span class="c1"># Split data using file amounts (but still considering groups)</span>
            <span class="n">quantity</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">train_cap</span> <span class="o">=</span> <span class="n">train_percentage</span> <span class="o">*</span> <span class="n">iftl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">browsing_order</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">iftl</span><span class="p">]</span> <span class="o">==</span> <span class="n">unique_groups</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span> <span class="c1"># contains each file index of the same grp</span>
                    <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="n">train_cap</span><span class="p">:</span>
                        <span class="n">train_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">iftl</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                        <span class="n">train_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">iftl</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># fill val only if train is full</span>
                        <span class="n">val_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">iftl</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                        <span class="n">val_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">iftl</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                <span class="n">quantity</span> <span class="o">+=</span> <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Store files and labels inside dictionaries (tdata for train, </span>
        <span class="c1"># vdata for val)</span>
        <span class="n">tdata</span> <span class="o">=</span> <span class="p">{</span><span class="n">filename</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> 
                                        <span class="nb">zip</span><span class="p">(</span><span class="n">train_files</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)}</span>
        <span class="n">vdata</span> <span class="o">=</span> <span class="p">{</span><span class="n">filename</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> 
                                        <span class="nb">zip</span><span class="p">(</span><span class="n">val_files</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">)}</span>

        <span class="c1"># Balance datasets (if required)</span>
        <span class="k">if</span> <span class="n">balance</span><span class="p">:</span>
            <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance_datasets</span><span class="p">(</span><span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span>
    

    <span class="c1"># @TODO maybe add an optional val_percentage and define a test set</span>
<div class="viewcode-block" id="DataHandler.split">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.split">[docs]</a>
    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_percentage</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Split labeled data into train and test datasets.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(float) train_percentage=0.7:</span>
<span class="sd">		    Percentage of data expected in train dataset.</span>
<span class="sd">        </span>
<span class="sd">		(bool) balance=False:</span>
<span class="sd">		    Do call &quot;balance_datasets&quot; method before returning dictionaries.</span>
<span class="sd">        </span>
<span class="sd">		(bool) ignore_groups=False:</span>
<span class="sd">            If True, ignore groups for the split, even though it is defined. </span>
<span class="sd">            If the &quot;groups&quot; attribute is not define, then it is ignored anyway. </span>
<span class="sd">            If it is defined and &quot;ignore_groups&quot; is False, then the split is done </span>
<span class="sd">            calling &quot;_split_using_groups&quot; method.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(dict&lt;str;str&gt;) tdata:</span>
<span class="sd">		    train dictionary with filename as key and label as value.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) vdata:</span>
<span class="sd">		    val dictionary with filename as key and label as value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> 
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| Load labeled data before calling &quot;split&quot;. &#39;</span>
                  <span class="s1">&#39;&quot;files&quot;, &quot;labels&quot; and &quot;unique_labels&quot; attributes should &#39;</span>
                  <span class="s1">&#39;not be None. Leaving.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">train_percentage</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">train_percentage</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|WRN| Should be: 0.00 &lt;= &quot;train_percentage&quot; &lt;= 1.00. Leaving.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_groups</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_using_groups</span><span class="p">(</span><span class="n">train_percentage</span><span class="p">,</span> <span class="n">balance</span><span class="p">)</span>

        <span class="c1"># Init arrays to store train/val files and labels</span>
        <span class="n">train_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="n">val_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="n">val_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">str_ndarray_dtype</span><span class="p">)</span>
        <span class="n">val_percentage</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">train_percentage</span>

        <span class="c1"># Fill train/val files/labels lab per lab referring to train_percentage</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="c1"># so the split is repeatable</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="c1"># but still random</span>
            <span class="n">startsat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">val_percentage</span><span class="p">))</span>
            <span class="n">train_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">train_files</span><span class="p">,</span> 
                                          <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">ids</span><span class="p">[</span><span class="n">startsat</span><span class="p">:]]])</span>
            <span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">train_labels</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">ids</span><span class="p">[</span><span class="n">startsat</span><span class="p">:]]])</span>
            <span class="n">val_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">val_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">ids</span><span class="p">[:</span><span class="n">startsat</span><span class="p">]]])</span>
            <span class="n">val_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">val_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">ids</span><span class="p">[:</span><span class="n">startsat</span><span class="p">]]])</span>
        
        <span class="c1"># Store files and labels inside dictionaries (tdata for train,</span>
        <span class="c1"># vdata for val)</span>
        <span class="n">tdata</span> <span class="o">=</span> <span class="p">{</span><span class="n">filename</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> 
                                        <span class="nb">zip</span><span class="p">(</span><span class="n">train_files</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)}</span>
        <span class="n">vdata</span> <span class="o">=</span> <span class="p">{</span><span class="n">filename</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> 
                                        <span class="nb">zip</span><span class="p">(</span><span class="n">val_files</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">)}</span>

        <span class="c1"># Balance datasets (if required)</span>
        <span class="k">if</span> <span class="n">balance</span><span class="p">:</span>
            <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance_datasets</span><span class="p">(</span><span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span></div>



    <span class="k">def</span> <span class="nf">_distribute_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Distribute files to process and split them between allowed cpus.</span>
<span class="sd">        The distribution is returned as 2 lists of lists of src or dstdir.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) dirpath:</span>
<span class="sd">		    Absolute path to the directory for treated files.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(list&lt;list&lt;str&gt;&gt;) packed_srcs:</span>
<span class="sd">		    Source files absolute paths per process.</span>
<span class="sd">        </span>
<span class="sd">		(list&lt;list&lt;str&gt;&gt;) packed_dstdirs:</span>
<span class="sd">		    Destination directories absolute paths per process.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Update destination directory with labels (if defined)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dstdirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dstdirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dirpath</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">size</span><span class="p">)])</span>
          
        <span class="c1"># Take file absolute paths</span>
        <span class="n">srcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">])</span>
        
        <span class="c1"># Pack src files and directories for multiprocessing</span>
        <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span> <span class="o">=</span> <span class="n">multiprocess</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span>
                               <span class="n">dstdirs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_cpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span>


    <span class="k">def</span> <span class="nf">_distribute_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tdstdir</span><span class="p">,</span> <span class="n">vdstdir</span><span class="p">,</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Distribute files to process and split them between allowed cpus.</span>
<span class="sd">        The distribution is returned into collections.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) tdstdir:</span>
<span class="sd">		    Absolute path to the destination files directory for train dataset.</span>
<span class="sd">        </span>
<span class="sd">		(str) vdstdir:</span>
<span class="sd">		    Absolute path to the destination files directory for val dataset.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) tdata:</span>
<span class="sd">		    Train dictionary with filename as key and label as value.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) vdata:</span>
<span class="sd">		    Val dictionary with filename as key and label as value.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(list&lt;list&lt;str&gt;&gt;) packed_srcs:</span>
<span class="sd">		    Src files absolute paths per process.</span>
<span class="sd">        </span>
<span class="sd">		(list&lt;list&lt;str&gt;&gt;) packed_dstdirs:</span>
<span class="sd">		    Destination directories absolute paths per process.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Define srcs and dstdirs</span>
        <span class="n">srcs</span><span class="p">,</span> <span class="n">dstdirs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">dirpath</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">],</span> <span class="p">[</span><span class="n">tdstdir</span><span class="p">,</span> <span class="n">vdstdir</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">srcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                <span class="n">dstdirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
        <span class="n">srcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span>
        <span class="n">dstdirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dstdirs</span><span class="p">)</span>

        <span class="c1"># Pack src files and directories for multiprocessing</span>
        <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span> <span class="o">=</span> <span class="n">multiprocess</span><span class="o">.</span><span class="n">distribute</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span> 
                              <span class="n">dstdirs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_cpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span>


    <span class="k">def</span> <span class="nf">_run_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run processes on the maximum amount of allowed CPUs to apply &quot;func&quot; </span>
<span class="sd">        function to each source file.</span>
<span class="sd">        &quot;func&quot; needs &quot;src&quot; and &quot;dstdir&quot; params (in acutils, those are </span>
<span class="sd">        prefixed with &quot;tmnt&quot;).</span>
<span class="sd">        **kwargs should be addionnal arguments to pass to the &quot;func&quot; function.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(array/list like of iterables of str) packed_srcs:</span>
<span class="sd">		    src files absolute paths per process.</span>
<span class="sd">        </span>
<span class="sd">		(array/list like of iterables of str) packed_dstdirs:</span>
<span class="sd">		    dst dirs absolute paths per process.</span>
<span class="sd">        </span>
<span class="sd">		(function) func:</span>
<span class="sd">            Treatment that will be applied on each source file</span>
<span class="sd">                it needs an absolute path to the source file &quot;src&quot; and absolute </span>
<span class="sd">                path to destination files directory &quot;dstdir&quot;. In acutils, </span>
<span class="sd">                any function prefixed with &quot;tmnt&quot; is usable.</span>

<span class="sd">        **kwargs:</span>
<span class="sd">            Arguments to pass to the &quot;func&quot; function.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">multiprocess</span><span class="o">.</span><span class="n">run_processes_on_multiple_files</span><span class="p">(</span><span class="n">packed_srcs</span><span class="p">,</span> 
                  <span class="n">packed_dstdirs</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_cpus</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_reset_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Delete directory if it exists, then create it again and fill it with</span>
<span class="sd">        empty subdirecories, named from unique labels (if defined and not empty).</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) dirpath:</span>
<span class="sd">		    Absolute path to the directory to reset.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">reset_directory</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_labels</span><span class="p">)</span>


<div class="viewcode-block" id="DataHandler.process">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.process">[docs]</a>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empty_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run processes on the maximum amount of allowed CPUs to apply &quot;func&quot; </span>
<span class="sd">        function to each source file. If &quot;func&quot; is None, just copy the file.</span>
<span class="sd">        &quot;func&quot; needs &quot;src&quot; and &quot;dstdir&quot; params (in acutils, those are </span>
<span class="sd">        prefixed with &quot;tmnt&quot;).</span>
<span class="sd">        **kwargs should be addionnal arguments to pass to the &quot;func&quot; function.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) dirpath:</span>
<span class="sd">		    Absolute path to treated files directory.</span>
<span class="sd">        </span>
<span class="sd">		(function) func=None:</span>
<span class="sd">            Treatment that will be applied on each source file it needs an </span>
<span class="sd">            absolute path to the source file &quot;src&quot; and absolute path to </span>
<span class="sd">            destination files directory &quot;dstdir&quot;. In acutils, any </span>
<span class="sd">            function prefixed with &quot;tmnt&quot; is usable.</span>
<span class="sd">                </span>
<span class="sd">		(bool) empty_dir=True:</span>
<span class="sd">		    If True, reset destination directory and fill it with unique labels</span>
<span class="sd">                as subdirectories if defined</span>

<span class="sd">        **kwargs:</span>
<span class="sd">            Arguments to pass to the &quot;func&quot; function.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Without treatment to apply, copy source files</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tmnt_copyfile_to_dir</span>
        
        <span class="c1"># Reset treated files directory </span>
        <span class="k">if</span> <span class="n">empty_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_directory</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>

        <span class="c1"># Distribute files between CPUs and run processes</span>
        <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distribute_data</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_processes</span><span class="p">(</span><span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataHandler.make_datasets">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.make_datasets">[docs]</a>
    <span class="k">def</span> <span class="nf">make_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainpath</span><span class="p">,</span> <span class="n">valpath</span><span class="p">,</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                      <span class="n">empty_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run processes on the maximum amount of allowed CPUs to apply &quot;func&quot; </span>
<span class="sd">        function to each source file.</span>
<span class="sd">        &quot;func&quot; needs &quot;src&quot; and &quot;dstdir&quot; params (in acutils, those are prefixed with &quot;tmnt&quot;).</span>
<span class="sd">        **kwargs should be addionnal arguments to pass to the &quot;func&quot; function.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) trainpath:</span>
<span class="sd">		    Absolute path to the destination files train directory.</span>
<span class="sd">        </span>
<span class="sd">		(str) valpath:</span>
<span class="sd">		    Absolute path to the destination files val directory.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) tdata:</span>
<span class="sd">		    Train dictionary with filename as key and label as value.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) vdata:</span>
<span class="sd">		    Val dictionary with filename as key and label as value.</span>
<span class="sd">        </span>
<span class="sd">		(function) func=None:</span>
<span class="sd">            Treatment that will be applied on each source file it needs an </span>
<span class="sd">            absolute path to the source file &quot;src&quot; and absolute path to </span>
<span class="sd">            destination files directory &quot;dstdir&quot;. In acutils, any </span>
<span class="sd">            function prefixed with &quot;tmnt&quot; is usable.</span>
<span class="sd">        </span>
<span class="sd">		(bool) empty_dir=True:</span>
<span class="sd">		    If True, reset destination directories and fill it with unique labels </span>
<span class="sd">            as subdirectories if defined.</span>

<span class="sd">        **kwargs: </span>
<span class="sd">            Arguments to pass to the &quot;func&quot; function.</span>
<span class="sd">    </span>
<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Without treatment to apply, copy source files</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tmnt_copyfile_to_dir</span>
        
        <span class="c1"># Reset train and val directories</span>
        <span class="k">if</span> <span class="n">empty_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_directory</span><span class="p">(</span><span class="n">trainpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_directory</span><span class="p">(</span><span class="n">valpath</span><span class="p">)</span>

        <span class="c1"># Distribute files between CPUs and run processes</span>
        <span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distribute_datasets</span><span class="p">(</span><span class="n">trainpath</span><span class="p">,</span> 
                                                    <span class="n">valpath</span><span class="p">,</span> <span class="n">tdata</span><span class="p">,</span> <span class="n">vdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_processes</span><span class="p">(</span><span class="n">packed_srcs</span><span class="p">,</span> <span class="n">packed_dstdirs</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataHandler.save_split">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.save_split">[docs]</a>
    <span class="k">def</span> <span class="nf">save_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save a split (from &quot;split&quot; method) as a json file.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) dst:</span>
<span class="sd">		    absolute path to the new json file.</span>
<span class="sd">        </span>
<span class="sd">		(dict&lt;str;str&gt;) data:</span>
<span class="sd">		    data dictionary to save.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------</span>
<span class="sd">		None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">save_dict_as_json</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataHandler.load_split">
<a class="viewcode-back" href="../../acutils.html#acutils.handler.DataHandler.load_split">[docs]</a>
    <span class="k">def</span> <span class="nf">load_split</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a dictionary from a json file.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------        </span>
<span class="sd">		(str) src:</span>
<span class="sd">		    absolute path to the json file.</span>

<span class="sd">        RETURNS</span>
<span class="sd">        -------        </span>
<span class="sd">		(dict&lt;str;str&gt;) data:</span>
<span class="sd">		    loaded data dictionary.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">load_dict_from_json</span><span class="p">(</span><span class="n">src</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Acuzle.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>